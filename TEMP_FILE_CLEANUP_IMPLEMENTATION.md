# 临时文件清理功能实现总结

## 修改概述

为了确保每次应用启动时都使用最新的core文件，我们对代码进行了以下修改：

## 主要修改

### 1. 平台工具类 (lib/utils/platform_utils.dart)

**修改内容:**
- 修改了`getExecutablePath()`方法，每次调用时都删除现有文件并重新复制
- 添加了`cleanupExecutableFiles()`方法，用于清理临时目录中的可执行文件
- 确保每次启动都使用最新的资源文件

**关键改进:**
```dart
// 每次启动都删除现有文件并重新复制
final file = File(executablePath);
if (await file.exists()) {
  await Logger.logInfo('删除现有可执行文件: $executablePath');
  await file.delete();
}
```

### 2. 主屏幕 (lib/screens/main_screen.dart)

**修改内容:**
- 在`initState()`中添加了`_cleanupOnStartup()`调用
- 添加了`_cleanupOnStartup()`方法，在应用启动时清理临时文件
- 导入了`PlatformUtils`类

**关键改进:**
```dart
void _cleanupOnStartup() async {
  try {
    await PlatformUtils.cleanupExecutableFiles();
  } catch (e) {
    // 忽略清理错误，不影响应用启动
  }
}
```

### 3. VPN服务 (lib/services/vpn_service.dart)

**修改内容:**
- 在`connect()`和`connectWithError()`方法中添加了清理步骤
- 确保在VPN连接前清理并重新获取可执行文件

**关键改进:**
```dart
// 清理并重新获取可执行文件路径
await PlatformUtils.cleanupExecutableFiles();
```

## 功能特性

### 清理机制
1. **启动时清理**: 应用启动时自动清理临时文件
2. **连接前清理**: VPN连接前再次清理并重新复制文件
3. **安全清理**: 清理失败不会影响应用正常运行

### 文件管理
1. **自动删除**: 删除临时目录中的旧文件
2. **重新复制**: 从assets重新复制最新的文件
3. **权限设置**: 自动设置正确的执行权限

### 错误处理
1. **容错机制**: 清理失败不会阻止应用启动
2. **日志记录**: 详细记录清理和复制过程
3. **优雅降级**: 如果清理失败，继续使用现有文件

## 工作流程

### 应用启动流程
1. 应用启动
2. 调用`_cleanupOnStartup()`
3. 清理临时目录中的旧文件
4. 继续正常的启动流程

### VPN连接流程
1. 用户点击连接
2. 验证订阅序号
3. 清理临时文件
4. 重新复制最新的core文件
5. 检查管理员权限
6. 启动VPN连接

## 平台支持

### 支持的平台
- ✅ macOS: `/tmp/appfast_connect/`
- ✅ Windows: `%TEMP%\appfast_connect\`
- ✅ Linux: `/tmp/appfast_connect/`

### 文件命名
- **macOS**: `core`
- **Windows**: `core.exe`
- **Linux**: `core`

## 安全考虑

### 文件完整性
- 每次启动都使用最新的资源文件
- 避免使用可能损坏的缓存文件
- 确保文件权限正确设置

### 错误处理
- 清理失败不会影响应用功能
- 详细的错误日志记录
- 优雅的错误恢复机制

## 性能影响

### 启动时间
- 清理操作通常在几毫秒内完成
- 文件复制操作通常需要几十毫秒
- 总体对启动时间影响很小

### 资源使用
- 临时文件大小通常为几MB
- 清理和复制操作内存使用很少
- 不会显著增加系统资源消耗

## 测试验证

### 测试场景
1. **正常启动**: 验证清理和复制功能正常
2. **文件损坏**: 验证能正确处理损坏的文件
3. **权限问题**: 验证权限不足时的处理
4. **网络问题**: 验证网络不可用时的处理

### 验证方法
1. 检查日志输出
2. 验证临时文件是否正确更新
3. 确认VPN连接功能正常
4. 测试多次启动的稳定性

## 维护说明

### 日志监控
- 关注清理操作的日志输出
- 监控文件复制是否成功
- 检查权限设置是否正确

### 故障排除
1. 如果清理失败，检查临时目录权限
2. 如果复制失败，检查assets文件是否存在
3. 如果权限设置失败，检查系统权限

## 后续优化

### 可能的改进
1. **增量更新**: 只在文件发生变化时重新复制
2. **版本检查**: 添加文件版本检查机制
3. **缓存优化**: 优化文件缓存策略

### 监控指标
1. 清理操作的成功率
2. 文件复制的时间
3. 启动时间的影响
4. 用户反馈和问题报告
