# 平台特定初始化文件架构说明

## 📁 文件结构

```
lib/
├── main_desktop.dart      # 主桌面入口文件（平台分发器）
├── main_macos.dart        # macOS 专用初始化文件
├── main_windows.dart      # Windows 专用初始化文件
└── main_linux.dart        # Linux 专用初始化文件
```

## 🎯 设计目标

将原来的单一 `main_desktop.dart` 文件拆分为多个平台特定的文件，每个系统使用不同的初始化逻辑，提高代码的可维护性和平台特定功能的实现。

## 🔧 实现方式

### 1. 主分发器 (`main_desktop.dart`)

主文件作为平台分发器，根据当前运行平台调用相应的初始化函数：

```dart
Future<void> initializePlatform() async {
  if (Platform.isMacOS) {
    await initializeMacOS();
  } else if (Platform.isWindows) {
    await initializeWindows();
  } else if (Platform.isLinux) {
    await initializeLinux();
  } else {
    await _defaultInitialize();
  }
}
```

### 2. 平台特定文件

每个平台都有独立的初始化文件，包含该平台特有的逻辑：

#### macOS (`main_macos.dart`)
- ✅ Applications文件夹权限检查
- ✅ macOS 特定的权限管理
- ✅ 系统信息调试
- ✅ 资源文件验证

#### Windows (`main_windows.dart`)
- ✅ Windows 特定的权限检查
- ✅ Windows 系统信息
- ✅ 资源文件验证
- ✅ Windows 托盘服务

#### Linux (`main_linux.dart`)
- ✅ Linux 特定的权限检查
- ✅ Linux 系统信息
- ✅ 资源文件验证
- ✅ Linux 托盘服务

## 🚀 优势

### 1. 代码分离
- 每个平台的特定逻辑独立维护
- 减少条件判断的复杂性
- 提高代码可读性

### 2. 平台优化
- 可以为每个平台实现最优的初始化流程
- 支持平台特定的功能和API
- 更好的错误处理和调试信息

### 3. 维护性
- 修改某个平台的逻辑不会影响其他平台
- 更容易进行平台特定的测试
- 清晰的代码组织结构

### 4. 扩展性
- 容易添加新的平台支持
- 可以为不同平台添加特定功能
- 支持平台特定的配置

## 📋 各平台特性对比

| 功能 | macOS | Windows | Linux |
|------|-------|---------|-------|
| 日志系统 | ✅ | ✅ | ✅ |
| VPN服务 | ✅ | ✅ | ✅ |
| 工作目录检查 | ✅ | ✅ | ✅ |
| 系统信息调试 | ✅ | ✅ | ✅ |
| 资源文件验证 | ✅ | ✅ | ✅ |
| 权限检查 | ✅ | ✅ | ✅ |
| 窗口管理 | ✅ | ✅ | ✅ |
| 托盘服务 | ✅ | ✅ | ✅ |
| Applications权限 | ✅ | ❌ | ❌ |
| 权限修复 | ✅ | ❌ | ❌ |

## 🔄 使用流程

1. **应用启动**: `main_desktop.dart` 被调用
2. **平台检测**: 检测当前运行平台
3. **函数分发**: 调用对应平台的初始化函数
4. **平台初始化**: 执行平台特定的初始化逻辑
5. **完成启动**: 返回主应用流程

## 🛠️ 开发建议

### 添加新平台
1. 创建新的平台文件 (如 `main_android.dart`)
2. 在主分发器中添加平台检测
3. 实现平台特定的初始化逻辑

### 修改平台逻辑
1. 直接修改对应的平台文件
2. 确保不影响其他平台
3. 测试修改后的功能

### 添加通用功能
1. 在主分发器中实现
2. 或在所有平台文件中添加相同逻辑
3. 考虑是否需要平台特定的实现

## 📝 注意事项

1. **导入依赖**: 确保每个平台文件导入必要的依赖
2. **错误处理**: 每个平台应该有适当的错误处理机制
3. **日志记录**: 使用统一的日志系统记录平台信息
4. **测试**: 在不同平台上测试初始化流程
5. **兼容性**: 确保代码在不同Flutter版本上的兼容性

## 🔍 调试

### 平台检测
```dart
print('当前平台: ${Platform.operatingSystem}');
print('平台版本: ${Platform.operatingSystemVersion}');
```

### 日志查看
每个平台都会记录详细的启动日志，可以通过日志系统查看初始化过程。

### 错误排查
如果某个平台初始化失败，检查：
1. 平台特定的依赖是否正确
2. 权限设置是否正确
3. 系统环境是否满足要求
